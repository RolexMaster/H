import tkinter as tk
import time
import ctypes
import threading
from ctypes import wintypes

def get_monitors_winapi():
    monitors = []

    def callback(hMonitor, hdcMonitor, lprcMonitor, dwData):
        r = lprcMonitor.contents
        monitors.append({
            "x": r.left,
            "y": r.top,
            "width": r.right - r.left,
            "height": r.bottom - r.top
        })
        return 1

    MONITORENUMPROC = ctypes.WINFUNCTYPE(
        ctypes.c_int,
        wintypes.HMONITOR,
        wintypes.HDC,
        ctypes.POINTER(wintypes.RECT),
        wintypes.LPARAM
    )

    ctypes.windll.user32.EnumDisplayMonitors(
        0, 0, MONITORENUMPROC(callback), 0
    )

    return monitors

class FadeOverlay:
    def __init__(self, monitor, max_opacity=0.9, steps=30, delay=50, duration_sec=3):
        self.monitor = monitor
        self.max_opacity = max_opacity
        self.steps = steps
        self.delay = delay
        self.duration_sec = duration_sec

        self.root = tk.Tk()
        self.root.overrideredirect(True)
        self.root.geometry(f"{monitor['width']}x{monitor['height']}+{monitor['x']}+{monitor['y']}")
        self.root.attributes("-topmost", True)
        self.root.attributes("-alpha", 0.0)
        self.root.configure(bg="black")

    def fade_in(self):
        for i in range(self.steps + 1):
            alpha = (i / self.steps) * self.max_opacity
            self.root.attributes("-alpha", alpha)
            self.root.update()
            time.sleep(self.delay / 1000)

    def fade_out(self):
        for i in reversed(range(self.steps + 1)):
            alpha = (i / self.steps) * self.max_opacity
            self.root.attributes("-alpha", alpha)
            self.root.update()
            time.sleep(self.delay / 1000)

    def run(self):
        self.fade_in()
        time.sleep(self.duration_sec)
        self.fade_out()
        self.root.destroy()

    def show(self):
        threading.Thread(target=self.run, daemon=True).start()
        self.root.mainloop()

def show_fade_overlay_all_monitors(duration_sec=3, max_opacity=0.85, steps=40, delay=30):
    monitors = get_monitors_winapi()
    overlays = []

    for monitor in monitors:
        overlay = FadeOverlay(
            monitor,
            max_opacity=max_opacity,
            steps=steps,
            delay=delay,
            duration_sec=duration_sec
        )
        overlays.append(overlay)

    # 모든 오버레이를 각각의 스레드로 실행
    for overlay in overlays:
        threading.Thread(target=overlay.show, daemon=True).start()

    # 첫 overlay 기준으로 전체 프로세스 유지
    overlays[0].root.mainloop()

# 실행
if __name__ == "__main__":
    show_fade_overlay_all_monitors(duration_sec=3, max_opacity=0.85, steps=40, delay=30)
